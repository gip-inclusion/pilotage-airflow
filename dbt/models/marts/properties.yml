version: 2

models:
  - name: suivi_candidatures_prescripteurs_habilites
    description: >
      Table introduite pour réaliser le tableau de bord prescripteurs.
      Elle a comme base la table [candidatures_echelle_locale](#!/source/source.dbt_pilotage.emplois.candidatures_echelle_locale) et ajoute une colonne `libelle_complet`
      à partir de la seed [organisation_libelles](#!/seeds/organisation_libelles) pour pouvoir afficher le libelle sur metabase tel
      qu'affiché sur les emplois.
  - name: suivi_prescripteurs_habilites
    description: >
      Table introduite pour réaliser le tableau de bord prescripteurs.
      Elle a comme base la table [organisations](#!/source/source.dbt_pilotage.emplois.organisations) + d'autres informations :
        - le nombre de siae partenaires de ces organisations
  - name: organisations_dihal
    description: >
      Table introduite pour réaliser le tableau de bord DIHAL.
      Nécessaire pour restreindre le choix des filtres uniquement aux prescripteurs de la DIHAL.
  - name: candidatures_dihal
    description: >
      Table introduite pour réaliser le tableau de bord DIHAL.
      Nécessaire pour restreindre le choix des filtres uniquement aux prescripteurs de la DIHAL.
  - name: suivi_auto_prescription
    description: >
      Table introduite pour le suivi de l'auto precription.
      Nécessaire pour selectionner les canditures concernées par l'auto prescription. Nous parlons d'auto prescription lorsque
      l'auteur du diagnostic et l'origine de la candidature proviennent du même employeur.
  - name: candidats_auto_prescription
    description: >
      Table introduite pour le suivi des candidats ayant bénéficié de l'auto precription.
      Nécessaire pour obtenir sélectionner les candidats concernés par l'auto prescription. Nous parlons d'auto prescription lorsque
      l'auteur du diagnostic et l'origine de la candidature proviennent du même employeur.
  - name: candidatures_echelle_locale
    description: >
      Table introduite pour le suivi des candidatures tout en ayant une information sur les bassins d'emploi d'où elles proviennent.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: source('emplois', 'candidatures')
  - name: candidatures_reseaux
    description: >
      Table introduite pour le suivi des candidatures des réseaux. Nous sommes obligés de créer une table séparée pour le suivi des candidatures des réseaux car une même structure peut appartenir à plusieurs réseaux.
      Cela a pour effet de générer donc des doublons. Ces derniers ne sont pas visibles via les TBs privés car nous sommes sur une vue filtrée, mais le chiffre total des candidatures est faussé.
  - name: reseaux
    description: >
      Table introduite pour obtenir la liste des réseaux et les structures attachées à ces derniers.
  - name: suivi_visiteurs_tous_tb
    description: >
      Table introduite pour suivre les visiteurs uniques des TBs prives et publics.
  - name: atigip_2022
    description: >
      Table créée à la demande de l'ATIGIP pour suivre les prescriptions des SPIPs.
      Focus sur 2022 donc table fixe, mais rangée dans le dossier marts car mis à dispo sur Metabase pour le partage avec ATIGIP.
  - name: suivi_consommation_etp_V2
    description: >
      Table créée pour suivre la consommation réelle d'ETPs par structure ainsi que leur conventionnement.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('suivi_etp_conventionnes_v2')
  - name: pass_agrements_valides
    description: >
      A la demande du C1, cette table a été créée pour suivre le nombre de pass IAE valides. Ici un pass est considéré valide quand sa date de fin n'a pas expiré.
      Afin d'informer si le pass est valide ou pas une colonne validite_pass remplie, avec les strings 'pass valide/pass non valide', a été créée.
      L'information contenue dans cette colonne n'est pas sous forme 1/0 afin d'anticiper une potentielle demande métier où cette colonne servirait de filtre.
      Cette colonne aurait pu être rajoutée dans {{source, pass_agréments}} mais un marts a été préféré à un ajout de colonne pour des raisons d'autonomie du côté des data analyst.
  - name: candidats_derniere_embauche
    description: >
      Table créée pour récupérer la dernière embauche (si elle existe) d'un candidat.
      Cette information est utilisée dans la table stats du C1 afin des filtrer les données des candidats par dernière date d'embauche.
  - name: suivi_etp_realises_v2
    description: >
      Table créée pour suivre le nombre d'etp réalisés. Cette table, permet, à travers le calcul du nombre d'heures x la valeur d'un etp de retrouver le nombre d'etp réalisés par mois et par personne physique.
  - name: suivi_etp_conventionnes_v2
    description: >
      Table créée pour suivre le nombre d'etp conventionnés ainsi que la part de ces ETPs financée par le CD et l'état. Cette table permet d'obtenir le bon nombre d'etp conventionné en considérant la bonne durée des annexes financières
  - name: etp_par_salarie
    description: >
      Table créée pour suivre le nombre d'etp réalisés par genre
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('suivi_etp_realises_v2')
  - name: candidats_enriched
    description: >
      Equivalent à la table candidat avec des informations complémentaires.
      Sera amenée à remplacer la table candidats des emplois mais comme cela risque de casser de nombreux indicateurs on préfère faire une table différente pour le moment.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: source('emplois', 'candidats')
  - name: candidatures_par_candidat
    description: >
      Permet de suvire les différentes candidatures réalisées par un candidat.
      Pour chaque candidat, on récupère le nb de candidatures réalisées ainsi que les infos sur ces candidatures sous forme de liste.
      La position de la donnée dans la liste permet la correspondance entre les différentes informations.
      Par exemple, si deux candidatures sont réalisées, les informations sur la première candidature sont données à l'indice 0 de la liste et celles de la deuxième à l'indice 1.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: source('emplois', 'candidats')
  - name: suivi_etp_realises_par_structure
    description: >
      Table de suivi des etps réalisés par structure.
  - name: suivi_etp_realises_par_structure_brsa
    description: >
      Table de suivi des etps réalisés par structure. Cette table permet aussi de savoir combien de salariés sont bRSA ou pas au sein de la structure et quelle a été leur consommation d'ETP.
      Afin d'être en accord avec les règles de la DGEFP et ASP, seuls les salariés ayant travaillé au moins une heure sont pris en compte dans cette table.
  - name: suivi_consommation_mensuelle_etp_V2
    description: >
      Table de suivi des etps réalisés et conventionnés par structure mois par mois.
  - name: prescripteurs_habilite_odc
    description: >
      Sous ensemble des prescripteurs_habilite de type ODC, DEPT et organisations habilitées BRSA.
  - name: candidatures_odc
    description: >
      Sous ensemble des candidatures_echelle_locale, uniquement celles orientées par les ODC, les DEPT, et les organisations habilitées BRSA.
  - name: candidats_odc
    description: >
      Sous ensemble des candidats, uniquement ceux qui ont une candidature orientée par les ODC, les DEPT, et les organisations habilitées BRSA.
  - name: suivi_tb_prive_semaine
    description: >
      Ce modèle python permet de calculer les visiteurs anciens et nouveaux chaque semaine à partir de la table suivi_visites_tb_prive_semaine.
      Il permet de calculer la rétention des utilisateurs sur les tableaux de bords privés.
  - name: suivi_complet_etps_conventionnes
    description: >
      Cette table nous permet d'obtenir une vue mensuelle du conventionnement en etp des différentes structures de l'IAE.
      En effet la table suivi_etp_conventionnes_v2 offre uniquement une vue agrégée par structure.
      Grâce à cette table nous pouvons suivre les conventionnements mois par mois de toutes les structures quelque soit leur durée de conventionnement.
  - name: suivi_realisation_convention_mensuelle
    description: >
      Cette table nous permet d'obtenir une vue mensuelle du conventionnement ET de la consommation en etp des différentes structures de l'IAE.
      Grâce à cette table nous pouvons réaliser des indicateurs suivant sur le même plot les conventionnements et consommation mois par mois de toutes les structures quelque soit leur durée de conventionnement.
