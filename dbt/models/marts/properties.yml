version: 2

models:
  - name: suivi_candidatures_prescripteurs_habilites
    description: >
      Table introduite pour réaliser le tableau de bord prescripteurs.
      Elle a comme base la table [candidatures_echelle_locale](#!/source/source.dbt_pilotage.emplois.candidatures_echelle_locale) et ajoute une colonne `libelle_complet`
      à partir de la seed [organisation_libelles](#!/seeds/organisation_libelles) pour pouvoir afficher le libelle sur metabase tel
      qu'affiché sur les emplois.
  - name: suivi_prescripteurs_habilites
    description: >
      Table introduite pour réaliser le tableau de bord prescripteurs.
      Elle a comme base la table [organisations](#!/source/source.dbt_pilotage.emplois.organisations) + d'autres informations :
        - le nombre de siae partenaires de ces organisations
  - name: organisations
    description: >
      Copie de la table organisations_v0 du c1 enrichie de données pour faire marcher certains filtres sur metabase.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: source('emplois', 'organisations_v0')
  - name: organisations_dihal
    description: >
      Table introduite pour réaliser le tableau de bord DIHAL.
      Nécessaire pour restreindre le choix des filtres uniquement aux prescripteurs de la DIHAL.
  - name: candidatures_dihal
    description: >
      Table introduite pour réaliser le tableau de bord DIHAL.
      Nécessaire pour restreindre le choix des filtres uniquement aux prescripteurs de la DIHAL.
  - name: suivi_auto_prescription
    description: >
      Table introduite pour le suivi de l'auto precription.
      Nécessaire pour selectionner les canditures concernées par l'auto prescription. Nous parlons d'auto prescription lorsque
      l'auteur du diagnostic et l'origine de la candidature proviennent du même employeur.
  - name: candidats_auto_prescription
    description: >
      Table introduite pour le suivi des candidats ayant bénéficié de l'auto precription.
      Nécessaire pour obtenir sélectionner les candidats concernés par l'auto prescription. Nous parlons d'auto prescription lorsque
      l'auteur du diagnostic et l'origine de la candidature proviennent du même employeur.
  - name: candidatures_echelle_locale
    description: >
      Table introduite pour le suivi des candidatures tout en ayant une information sur les bassins d'emploi d'où elles proviennent.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: source('emplois', 'candidatures')
  - name: candidatures_reseaux
    description: >
      Table introduite pour le suivi des candidatures des réseaux. Nous sommes obligés de créer une table séparée pour le suivi des candidatures des réseaux car une même structure peut appartenir à plusieurs réseaux.
      Cela a pour effet de générer donc des doublons. Ces derniers ne sont pas visibles via les TBs privés car nous sommes sur une vue filtrée, mais le chiffre total des candidatures est faussé.
  - name: reseaux
    description: >
      Table introduite pour obtenir la liste des réseaux et les structures attachées à ces derniers.
  - name: suivi_visiteurs_tous_tb
    description: >
      Table introduite pour suivre les visiteurs uniques des TBs prives et publics.
  - name: atigip_2022
    description: >
      Table créée à la demande de l'ATIGIP pour suivre les prescriptions des SPIPs.
      Focus sur 2022 donc table fixe, mais rangée dans le dossier marts car mis à dispo sur Metabase pour le partage avec ATIGIP.
  - name: suivi_consommation_etp_V2
    description: >
      Table créée pour suivre la consommation réelle d'ETPs par structure ainsi que leur conventionnement.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('suivi_etp_conventionnes_v2')
  - name: pass_agrements_valides
    description: >
      A la demande du C1, cette table a été créée pour suivre le nombre de pass IAE valides. Ici un pass est considéré valide quand sa date de fin n'a pas expiré.
      Afin d'informer si le pass est valide ou pas une colonne validite_pass remplie, avec les strings 'pass valide/pass non valide', a été créée.
      L'information contenue dans cette colonne n'est pas sous forme 1/0 afin d'anticiper une potentielle demande métier où cette colonne servirait de filtre.
      Cette colonne aurait pu être rajoutée dans {{source, pass_agréments}} mais un marts a été préféré à un ajout de colonne pour des raisons d'autonomie du côté des data analyst.
  - name: candidats_derniere_embauche
    description: >
      Table créée pour récupérer la dernière embauche (si elle existe) d'un candidat.
      Cette information est utilisée dans la table stats du C1 afin des filtrer les données des candidats par dernière date d'embauche.
  - name: suivi_etp_realises_v2
    description: >
      Table créée pour suivre le nombre d'etp réalisés. Cette table, permet, à travers le calcul du nombre d'heures x la valeur d'un etp de retrouver le nombre d'etp réalisés par mois et par personne physique.
  - name: suivi_etp_conventionnes_v2
    description: >
      Table créée pour suivre le nombre d'etp conventionnés ainsi que la part de ces ETPs financée par le CD et l'état. Cette table permet d'obtenir le bon nombre d'etp conventionné en considérant la bonne durée des annexes financières
  - name: etp_par_salarie
    description: >
      Table créée pour suivre le nombre d'etp réalisés par genre
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('suivi_etp_realises_v2')
  - name: candidats
    description: >
      Equivalent à la table candidat_v0 avec des informations complémentaires.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: source('emplois', 'candidats_v0')
  - name: candidatures_par_candidat
    description: >
      Permet de suvire les différentes candidatures réalisées par un candidat.
      Pour chaque candidat, on récupère le nb de candidatures réalisées ainsi que les infos sur ces candidatures sous forme de liste.
      La position de la donnée dans la liste permet la correspondance entre les différentes informations.
      Par exemple, si deux candidatures sont réalisées, les informations sur la première candidature sont données à l'indice 0 de la liste et celles de la deuxième à l'indice 1.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: source('emplois', 'candidats_v0')
  - name: suivi_etp_realises_par_structure
    description: >
      Table de suivi des etps réalisés par structure. Cette table permet aussi de suivre si l'état mensuel a été validé.
      L'état mensuel est rempli PAR salarié or cette table est agrégée par structure, le test ci dessous permet de vérifier que l'état mensuel est bien modifié pour tous les salariés en même temps.
      Si pour deux salariés de la même structure on a un état "VALIDE" pour l'un et "BROUILLON" pour l'autre le test renverra une erreur.
      Normalement l'approche métier veut que tous les salariés soient traités en même temps et que l'on ait un statut unique par structure, ce test est là pour éviter une éventuelle erreur côté métier.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('stg_test_suivi_etp_realises_par_structure')
  - name: suivi_etp_realises_par_structure_brsa
    description: >
      Table de suivi des etps réalisés par structure. Cette table permet aussi de savoir combien de salariés sont bRSA ou pas au sein de la structure et quelle a été leur consommation d'ETP.
      Afin d'être en accord avec les règles de la DGEFP et ASP, seuls les salariés ayant travaillé au moins une heure sont pris en compte dans cette table
  - name: suivi_consommation_mensuelle_etp_V2
    description: >
      Table de suivi des etps réalisés et conventionnés par structure mois par mois.
  - name: prescripteurs_habilites_odc
    description: >
      Sous ensemble des prescripteurs_habilite de type ODC, DEPT et organisations habilitées BRSA.
  - name: candidatures_odc
    description: >
      Sous ensemble des candidatures_echelle_locale, uniquement celles orientées par les ODC, les DEPT, et les organisations habilitées BRSA.
  - name: candidats_odc
    description: >
      Sous ensemble des candidats, uniquement ceux qui ont une candidature orientée par les ODC, les DEPT, et les organisations habilitées BRSA.
  - name: suivi_tb_prive_semaine
    description: >
      Ce modèle python permet de calculer les visiteurs anciens et nouveaux chaque semaine à partir de la table suivi_visites_tb_prive_semaine.
      Il permet de calculer la rétention des utilisateurs sur les tableaux de bords privés.
  - name: taux_transformation_prescripteurs
    description: >
      Contient le nombre d'acceptations par candidat et par prescripteur pour permettre le calcul du taux de transformation par prescripteur.
  - name: delai_1ere_candidature_embauche
    description : >
      Contient pour chaque candidat le délai entre sa première candidature et l'embauche.
  - name: sorties_toutes_structures
    description: >
      Table contenant les motifs de sorties pour tous les salariés ayant travaillé dans une SIAE entre l'année N et l'année N-2.
  - name: suivi_complet_etps_conventionnes
    description: >
      Cette table nous permet d'obtenir une vue mensuelle du conventionnement en etp des différentes structures de l'IAE.
      En effet la table suivi_etp_conventionnes_v2 offre uniquement une vue agrégée par structure.
      Grâce à cette table nous pouvons suivre les conventionnements mois par mois de toutes les structures quelle que soit leur durée de conventionnement.
  - name: suivi_realisation_convention_mensuelle
    description: >
      Cette table nous permet d'obtenir une vue mensuelle du conventionnement ET de la consommation en etp des différentes structures de l'IAE.
      Grâce à cette table nous pouvons réaliser des indicateurs suivant sur le même plot les conventionnements et consommation mois par mois de toutes les structures quelle que soit leur durée de conventionnement.
  - name: suivi_demandes_prolongations
    description: >
      Cette table permet de suivre toutes les demandes de prolongation (passant ou pas par les prescipteurs habilités).
      Sa création est nécessaire afin d'identifier les SIAE ainsi que les types de prescipteur traitant la prolongation ainsi que les demandes gérées par ces derniers.
      Cette table est une union entre une vue regroupant les demandes/prolongations acceptées et une vue regroupant les demandes non acceptées.
      Cette union est nécessaire car l'architecture des tables prolongations et demandes_de_prolongation ne permettent pas une jointure simple.
  - name: candidats_prescripteurs_habilites
    description: >
      Table permettant de suivre les candidats qui ont été diagnostiqués par des prescripteurs habilités et d'avoir des infos sur leur diagnostic.
      Réalisée pour permettre au c0 d'avoir des statistiques sur la manière dont les diagnostics des ph sont réalisés.
  - name: nps_hebdo_reco_hebdo_par_tb
    description: >
      Table permettant le suivi du nps de tous les tbs du pilotage à partir de la table suivi_satisfaction.
  - name: suivi_realisation_convention_par_structure
    description: >
      Table permettant de suivre par id d'annexe financiere (i.e. par structure et par an) les etps conventionnés, réalisés et la différence entre ces derniers.
      Le delta calculé ici permet de calculer un % de réalisation sur les états mensuels validés très utile au pilotage de l'activité des structures effectuée par les réseaux.
  - name: nb_utilisateurs_potentiels
    description: >
      Table pour le suivi des statistiques de pilotage en interne : pour chaque cible, donne le nb d'utilisateurs potentiels des TBs.
  - name: utilisateurs_jamais_venus
    description: >
      Table permettant de récupérer les mails des utilisateurs ne s'étant jamais connectés sur les tb prives. A ce jour impossible de savoir à quelle orga cette utilisateur est rattaché mais cela arrive dans une v2.
    tests:
    - dbt_utils.equal_rowcount:
        compare_model: source('emplois', 'utilisateurs')
  - name: pass_iae_et_demandes
    description: >
      Table permettant de suivre les PASS IAE n'ayant jamais été associés à une demande de prolongation et ceux associés à une (ou plusieurs) demande de prolongation.
      A noter, le même pass IAE peut avoir deux entrées dans cette table car une demande peut etre refusée, ce qui amène souvent à une nouvelle demande, qui elle peut être acceptée.
  - name: suivi_cap_structures
    description: >
      Suivi des structures ayant fait l'objet du contrôle a posteriori. Table réalisée pour la réalisation du tb suivi du contrôle a posteriori.
  - name: suivi_cap_critères
    description: >
      Suivi des critères vérifiés dans le cadre du contrôle a posteriori. Table réalisée pour la réalisation du tb suivi du contrôle a posteriori.
  - name: suivi_cap
    description: >
      Contient les statistiques de contrôle des structures pour toutes les campagnes de contrôle. Table réalisée pour la réalisation du tb suivi du contrôle a posteriori.
  - name: fiches_deposte_en_tension_recrutement
    description: >
      Fiches de postes par structure et leur état. Pour la réalisation du TB fiches postes en tension.