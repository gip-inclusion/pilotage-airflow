version: 2

models:
  - name: stg_insee_appartenance_geo_communes
    description: >
      Ce modèle liste les communes françaises recensées par l'insee
      et donne pour chaque commune son appartenance géographique
      en terme de : département, région, zone d'emploi, epci et arrondissement.
      Elle a comme base la [table d'appartenance géographique des communes](https://www.insee.fr/fr/information/2028028) de l'insee (seeds.insee_geo.insee_communes)
      enrichie des libellés par un croisement avec les tables insee nécessaires (seeds.insee_geo.insee_departements, insee_regions, insee_epcis, insee_arrondissements)
      Cette table permet d'enrichir n'importe quelle donnée géographique identifiée par un code commune en passant par cette unique table au lieu de recalculer les jointures à chaque fois.
      Elle a été introduite pour agréger les données de candidatures en fonction de leur appartenance géographique.
  - name: stg_candidatures_autoprescription
    description: >
      Ce modèle permet de sélectionner les candidatures provenant d'une auto prescription.
      Nous parlons d'auto prescription lorsque l'auteur du diagnostic et l'origine de la candidature proviennent du même employeur.
  - name: stg_structures
    description: >
      Ce modèle permet de selectionner certaines informations (id, active, siret, ville et nom complet de la structure) de la table structures et de lever des ambiguités dans les noms de colonne, en particulier avec les départements.
  - name: stg_candidats_count
    description: >
      Ce modèle permet de compter le nombre de candidats lorsqu'une jointure est faite avec la table candidatures.
  - name: stg_candidats_autoprescription
    description: >
      Ce modèle permet de sélectionner les candidats provenant d'une auto prescription.
      Nous parlons d'auto prescription lorsque l'auteur du diagnostic et l'origine de la candidature proviennent du même employeur.
  - name: stg_candidatures
    description: >
      Ce modèle récupère les données de la table c1 candidatures et y applique quelques modifications de renommage ou d'extraction de données.
  - name: stg_organisations
    description: >
      Ce modèle récupère les données de la table c1 organisations et y ajoute des colonnes pour faciliter le déploiement de tableaux metabase liés aux prescripteurs.
      Une colonne type_complet_avec_habilitation permet notamment de rendre cohérent le nom des prescripteurs avec celui de la table candidature.
      Elle pourra également être enrichie d'autres données sur les organisations comme le nombre de structures partenaires, le nombre de prescriptions réalisées, etc.
    tests:
      - dbt_utils.expression_is_true:
          # we check that those columns match as much as possible, knowing that the first one is prefixed by the department code: "01 - Ain".
          expression: >
            split_part("nom_département", ' - ', 2) = "nom_département_insee"
  - name: stg_reseaux
    description: >
      Ce modèle récupère les données des tables reseau_iae_adherents et reseau_iae_ids afin d'associer l'id reseau correspondant à chaque structure.
  - name: stg_bassin_emploi
    description: >
      Ce modèle récupère les données des bassins d'emploi pour chaque structure.
  - name: stg_org_prescripteur
    description: >
      Ce modèle récupère des informations de localisation (département, région) de tous les prescripteurs.
  - name: stg_siae_partenaires_prescripteurs
    description: >
      Permet de suivre le nb de siae partenaires d'une organisation.
      A ce jour table très simple permettant uniquement de compter les SIAE partenaires pour le suivi des prescriptions des prescripteurs habilités,
      mais pourra évoluer à terme et intégrer davantage d'infos sur les partenariats.
  - name: stg_visiteurs_publics
    description: >
      Permet de suivre les metrics matomo associees aux TB publics
  - name: stg_visiteurs_prives
    description: >
      Cette table suit les metrics des TBs prives avant l'automatisation des requêtes API Matomo introduite par Victor.
  - name: stg_visiteurs_prives_v1
    description: >
      Cette table suit les metrics des TBs prives après l'automatisation des requêtes API Matomo introduite par Victor.
  - name: stg_duree_annexe
    description: >
      Vue créée pour extraire des informations sur la durée des annexes financières à partir du fluxIAE de l'ASP.
  - name: stg_consommation_etp
    description: >
      Vue créée pour calculer les ETPs réalisés à partir du fluxIAE de l'ASP.
  - name: stg_candidats_candidatures
    description: >
      Vue créée pour joindre les dates d'embauche de chaque candidat. Cette vue est utilisée dans candidats_derniere_embauche.sql pour extraire la dernière date d'embauche d'un candidat.
  - name: stg_salarie
    description: >
      Vue créée pour récupérer les id uniques des salarié(e)s ainsi que leur genre afin de permettre le calcul des ETPs par genre.
  - name: stg_sorties_finales
    description: >
      Vue créée afin de servir de base pour créer des tables prenant en compte les spécifité de sortie de chaque type de SIAE.
  - name: stg_candidats
    description: >
      Vue permettant de calculer des informations concernant les candidats. Elle sert à ce jour à récupérer l'âge du candidat à partir du nir.
  - name: stg_etat_mensuel_individuel_avec_brsa
    description: >
      Vue permettant de déterminer si une personne physique est bénéficiaire du RSA ou pas. Elle sert à ce jour à identifier le nombre de bRSA par structure.
  - name: stg_etp_conventionnes
    description: >
      Vue permettant de calculer les ETPs conventionnés. Elle sert à la création du suivi des ETPs conventionnés.
  - name: stg_prescripteurs_odc
    description: >
      Vue contenant les prescripteurs habilité de type ODC, DEPT et ceux habilités BRSA.
  - name: stg_c1_private_dashboards_visits_v1
    description: >
      Vue contenant les visiteurs des TBs privés provenant des emplois de l'inclusion.
  - name: stg_sorties_eiti
    description: >
      Vue contenant les sorties pour chaque salarié(e) des EITI. Les EITI n'ont pas de règle particulière définissant lorsqu'une sortie doit être prise en compte.
  - name: stg_sorties_ai_etti
    description: >
      Vue contenant les sorties pour chaque salarié(e) des AI et ETTI.
      Pour ces deux type de SIAE, une sortie est prise en compte lorsque la personne a travaillé plus de 150h en cumulé dans la SIAE.
  - name: stg_sorties_aci_ei
    description: >
      Vue contenant les sorties pour chaque salarié(e) des ACI et EI.
      Pour ces deux type de SIAE, une sortie est prise en compte lorsque :
        - la personne a travaillé plus de 3 mois au total dans une ACI/EI
        - la personne a travaillé au moins une heure dans l'année de sortie de la SIAE.
  - name: stg_suivi_cap_reponses_controle
    description: >
        Pour toutes les structures à contrôler dans le cadre du contrôle a posteriori, permet de distinguer celles qui ont répondu au contrôle.
        Une structure a répondu au contrôle si elle a transmis un justificatif.
        Elle sert de base pour ajouter cette information sur la table suivi_cap_structure et permet ainsi le calcul du taux de réponse au contrôle.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: source('emplois', 'cap_structures')
  - name: stg_test_suivi_etp_realises_par_structure
    description: >
      Vue permettant de tester le nombre de lignes de la table suivi_etp_realises_par_structure.
  - name: stg_fdp_candidatures
    description: >
      Contient la liste des candidatures pour toutes les fiches de postes.
      Permet de calculer l'état d'une fiche de poste et pour pouvoir reconnaître les fiches de poste en difficulté de recrutement.
  - name: stg_fdp
    description: >
      Contient la liste des fiches de poste et leur état (active, sans recrutement, difficulte de recrutement...) pour toutes les structures.
      Les états sont calculés à partir de la vue stg_candidatures
  - name: stg_fdp_actives
    description: >
      Contient la liste des fiches de poste actives, ie celles qui ont le statut "recrutement ouvert".
  - name: stg_fdp_actives_sans_rec_30jrs
    description: >
      Fiches de poste sans candidatures sur les 30 derniers jours ou avec des candidatures mais sans recrutement.
  - name: stg_fdp_actives_sans_rec_30jrs_sans_motif_pasdeposteouvert
    description: >
      Fiches de postes sans candidatures sur les 30 derniers jours ou avec des candidatures mais sans recrutement et dont l’employeur n'a pas refusé des candidatures dans les 30 derniers jours pour le motif "Pas de poste ouvert".
  - name: stg_fdp_difficulte_recrutement
    description: >
      Fiches de poste sans candidatures sur les 30 derniers jours ou avec des candidatures mais sans recrutement et dont l’employeur n'a pas refusé des candidatures dans les 30 derniers jours pour le motif "Pas de poste ouvert" et dont la fiche de poste est en ligne depuis plus de 30 jours.
  - name: stg_fdp_difficulte_recrutement_sans_candidatures
    description: >
      Fiches de poste en difficulté de recrutement et n'ayant jamais reçu de candidatures.